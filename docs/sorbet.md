# Sorbet (static + runtime type checking)

This project uses [Sorbet](https://sorbet.org) for static and runtime type checking, and [Tapioca](https://github.com/Shopify/tapioca) to generate and keep RBI files for gems in sync with dependencies.

**Ruby version:** This project stays on **Ruby 2.7** until rspock (and its dependency ast_transform) support newer Ruby — both gems specify `required_ruby_version: ~> 2.5` (< 3.0) and are unmaintained since 2020. We pin **sorbet to 0.5.11010** (the first version where sorbet-static ships as `universal-darwin` with no macOS version suffix, so it works on any macOS) and **sorbet-runtime to 0.5.10461** (a version that does not enforce `abstract!` at runtime — rbi 0.0.x declares `RBI::Param` as abstract, and newer sorbet-runtime crashes on it). **Tapioca ~> 0.5.4** (before [PR #865](https://github.com/Shopify/tapioca/pull/865)) depends on sorbet-static and sorbet-runtime separately, and Bundler resolves `rbi` to **0.0.16** (the last version whose `parser >= 2.6.4.0` is compatible with rspock's `parser ~> 2.5`). When rspock supports Ruby 3.2+, we can use latest sorbet + Tapioca 0.17+ (with rbi 0.3.5+ where `abstract!` is removed) and drop all these pins.

## Commands

- **`dev tc`** — Run type checking. This:
  1. Verifies that gem RBIs under `sorbet/rbi/gems/` are in sync with `Gemfile.lock` (so drift is detected locally, not only on CI).
  2. Runs `srb tc`.
  - If RBIs are out of date, the command fails with instructions to run `dev rbi` and commit the updated files.

## Strictness

- **New application code:** Use `# typed: strict` at the top of the file. We aim for strict by default for new files.
- **Tests:** Tests are harder to keep at `typed: strict`; using `# typed: true` (or lower) for test files is acceptable.
- A future lint rule may enforce that new files use `typed: strict`; tests will have wiggle room.

## Keeping gem RBIs in sync

- After changing dependencies (`bundle install` / `bundle update`), regenerate gem RBIs and commit them:
  ```bash
  dev rbi
  ```
- **`dev tc`** runs `tapioca gem --verify` before `srb tc`, so if you forget to update RBIs, typecheck will fail locally with a clear message. CI also runs the same step before tests.

## Annotation compatibility

Files under `sorbet/rbi/annotations/` are community-maintained type annotations pulled from [rbi-central](https://github.com/Shopify/rbi-central). They're generated by `tapioca annotations` (not available in our tapioca 0.5.x) or `tapioca init`, so `dev rbi` won't overwrite them.

Some annotations use features our Sorbet version doesn't support. Known fixes (re-apply if annotations are ever regenerated):

- **`minitest.rbi` — `assert_raises` overloaded sigs:** The upstream annotation uses two `sig` blocks before one `def` (an [overload pattern](https://sorbet.org/docs/overloads) only supported in newer Sorbet). Our 0.5.x reports error 5040. Fix: merge the two sigs into one with `NilClass` added to the union.
- **`mocha.rbi` — `Expectation#with` conflict:** The annotation defines `with` with `**kwargs`, but the generated RBI doesn't include it (error 4010). Fix: remove the `with` sig from the annotations file (the generated definition still provides the method).

## First-time setup (after adding Sorbet)

1. `bundle install`
2. `bundle exec tapioca init` (creates `sorbet/` and `bin/tapioca`)
3. Commit the new/updated `sorbet/` directory and `bin/tapioca`

## References

- [Adopting Sorbet](https://sorbet.org/docs/adopting)
- [Tapioca — Keeping RBI files for gems up-to-date](https://github.com/Shopify/tapioca?tab=readme-ov-file#keeping-rbi-files-for-gems-up-to-date)
